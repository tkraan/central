apiVersion: v1
data:
  odk.conf.template: |
    server {
      listen 443 default_server ssl;
      server_tokens off;

      ssl_certificate /etc/nginx/ssl/nginx.default.crt;
      ssl_certificate_key /etc/nginx/ssl/nginx.default.key;

      return 421;
    }

    map "$request_method::$uri$is_args$args" $cache_strategy {
      # general
      ~^(GET|HEAD)::/client-config.json$ "revalidate";
      ~^(GET|HEAD)::/favicon.ico$        "revalidate";
      ~^(GET|HEAD)::/robots.txt$         "revalidate";
      ~^(GET|HEAD)::/version.txt$        "revalidate";

      # central-backend
      ~^(GET|HEAD)::/v1/                 "passthrough";

      # central-frontend - unversioned
      ~^(GET|HEAD)::/$             "revalidate";
      ~^(GET|HEAD)::/index.html$   "revalidate";
      ~^(GET|HEAD)::/blank.html$   "revalidate";
      ~^(GET|HEAD)::/fonts/.*\?\w+ "immutable";
      ~^(GET|HEAD)::/fonts/        "revalidate";

      # central-frontend - versioned
      ~^(GET|HEAD)::/assets/ "immutable";

      # enketo
      ~^(GET|HEAD)::/-(/x)?/css/                 "revalidate";
      ~^(GET|HEAD)::/-(/x)?/fonts/.*?v=          "immutable";
      ~^(GET|HEAD)::/-(/x)?/fonts/               "revalidate";
      ~^(GET|HEAD)::/-(/x)?/images/              "revalidate";
      ~^(GET|HEAD)::/-(/x)?/js/build/chunks/     "immutable";
      ~^(GET|HEAD)::/-(/x)?/js/build/            "revalidate";
      ~^(GET|HEAD)::/-(/x)?/locales/             "revalidate";
      ~^(GET|HEAD)::/-/x/[a-zA-Z0-9]+            "revalidate";
      ~^(GET|HEAD)::/-/x/offline-app-worker\.js$ "revalidate";

      default "single-use";
    }
    map $cache_strategy $cache_header_cache_control {
      "immutable"  "max-age=31536000";
      "revalidate" "no-cache";
      "passthrough"  "";
      default      "no-store";
    }
    map $cache_strategy $cache_header_pragma {
      "immutable"  "";
      "revalidate" "no-cache";
      "passthrough"  "";
      default      "no-cache";
    }
    map $cache_strategy $cache_header_vary {
      "immutable"  "Accept-Encoding";
      "revalidate" "Accept-Encoding";
      "passthrough"  "";
      default      "*";
    }

    map $args $qp_deliminator {
      ~.+ "&";
      default "?";
    }

    map $arg_st $redirect_non_single_prefix {
      ~.+     "${is_args}${args}${qp_deliminator}single=false";
      default "/new${is_args}${args}";
    }

    map $arg_st $redirect_single_prefix {
      ~.+     "${is_args}${args}";
      default "/new${is_args}${args}${qp_deliminator}single=true";
    }

    # Use 'none' per directive instead of falling back to default-src to make CSP violation reports more specific
    # Note: using $request_uri here remains safe while percent-encodings are not
    # normalised in frontend URLs.  Tracked at https://github.com/getodk/central/issues/1532
    map $request_uri $central_frontend_csp {
      # Web Forms CSP for /f/... and /projects/.../forms/... routes
      ~^/(?:f/[^/]+(?:/.*)?|projects/\d+/forms/[^/]+/(?:(?:draft/)?(?:preview|submissions/new(?:/offline)?)|submissions/[^/]+/edit)(?:/)?)(?:\?.*)?$
        "default-src 'none'; connect-src 'self' https:; font-src 'self' data:; frame-src 'none'; img-src blob: https:; manifest-src 'none'; media-src 'none'; object-src 'none'; script-src 'self' 'wasm-unsafe-eval'; style-src 'self' 'unsafe-inline'; worker-src blob:; report-uri /csp-report";

      default
        "default-src 'none'; connect-src 'self' https://translate.google.com https://translate.googleapis.com; font-src 'self'; frame-src 'self' https://getodk.github.io/central/news.html; img-src data: https:; manifest-src 'none'; media-src 'none'; object-src 'none'; script-src 'self'; style-src 'self'; style-src-attr 'unsafe-inline'; worker-src blob:; report-uri /csp-report";
    }

    server {
      listen 443 ssl;
      http2 on;
      server_name ${DOMAIN};

      ssl_certificate /etc/${SSL_TYPE}/live/${CERT_DOMAIN}/fullchain.pem;
      ssl_certificate_key /etc/${SSL_TYPE}/live/${CERT_DOMAIN}/privkey.pem;
      ssl_trusted_certificate /etc/${SSL_TYPE}/live/${CERT_DOMAIN}/fullchain.pem;

      ssl_protocols TLSv1.2 TLSv1.3;
      ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
      ssl_prefer_server_ciphers off;

      ssl_dhparam /etc/dh/nginx.pem;

      server_tokens off;

      add_header Content-Security-Policy-Report-Only "default-src 'none'; connect-src https://translate.google.com https://translate.googleapis.com; img-src https://translate.google.com; report-uri /csp-report";
      include /usr/share/odk/nginx/common-headers.conf;

      client_max_body_size 100m;

      gzip on;
      gzip_comp_level 6;
      gzip_vary on;
      gzip_min_length 1024;
      gzip_http_version 1.1;
      gzip_types text/plain text/css application/json application/geo+json application/x-javascript application/javascript text/xml application/xml text/csv image/svg+xml;
      gzip_proxied any;

      # Enketo Configuration.
      # Enketo express is traditionally served at /- but with the introduction of ODK Web Forms
      # we want old Enketo URLs redirected to a Central frontend page which dynamically decides
      # whether to show a WebForm or an iframed Enketo.
      #
      # Following are the locations that serve a Form and these are redirected to the frontend:
      location ~ "^/-/single/(?<enketoId>[a-zA-Z0-9]+)$" {
        # Form fill link, public
        # If 'st' query parameter is not present, redirect to protected route with single only
        # end-of-form behavior (/new?single=true)
        return 301 "/f/$enketoId$redirect_single_prefix";
      }
      location ~ "^/-/preview/(?<enketoId>[a-zA-Z0-9]+)$" {
        # preview link
        return 301 "/f/$enketoId/preview$is_args$args";
      }
      # The negative look ahead patterns in the following regex are for the Enketo endpoints which are
      # similar to the new submission endpoint i.e. /-/:enketoId but these are not enketoId, therefore
      # we don't want them to be redirected to central-frontend
      location ~ "^/-/(?!thanks$|connection$|login$|logout$|api$|preview$)(?<enketoId>[a-zA-Z0-9]+)$" {
        # Form fill link (non-public), or Draft
        # If 'st' query parameter is present, add ?single=false for public access
        return 301 "/f/$enketoId$redirect_non_single_prefix";
      }
      # To read single submission cookies
      location = /-/single/check-submitted {
        try_files $uri @blank.html;
      }

      # For that iframe to work, we'll need another path prefix (enketo-passthrough) under which we can
      # reach Enketo â€” this one will not be intercepted.
      location ~ ^/(?:-|enketo-passthrough)(?:/|$) {
        rewrite ^/enketo-passthrough(/.*)?$ /-$1 break;
        proxy_pass http://enketo:8005;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_hide_header Vary;
        proxy_hide_header Cache-Control;

        # More lax CSP for enketo-express:
        # Google Maps API: https://developers.google.com/maps/documentation/javascript/content-security-policy
        # Use 'none' per directive instead of falling back to default-src to make CSP violation reports more specific
        proxy_hide_header Content-Security-Policy-Report-Only;
        add_header Content-Security-Policy-Report-Only "default-src 'none'; connect-src 'self' blob: https://maps.googleapis.com/ https://maps.google.com/ https://maps.gstatic.com/mapfiles/ https://fonts.gstatic.com/ https://fonts.googleapis.com/ https://translate.google.com https://translate.googleapis.com; font-src 'self' https://fonts.gstatic.com/; frame-src 'none'; img-src data: blob: jr: 'self' https://maps.google.com/maps/ https://maps.gstatic.com/mapfiles/ https://maps.googleapis.com/maps/ https://tile.openstreetmap.org/ https://translate.google.com; manifest-src 'none'; media-src blob: jr: 'self'; object-src 'none'; script-src 'unsafe-inline' 'self' https://maps.googleapis.com/maps/api/js/ https://maps.google.com/maps/ https://maps.google.com/maps-api-v3/api/js/; style-src 'unsafe-inline' 'self' https://fonts.googleapis.com/css; style-src-attr 'unsafe-inline'; report-uri /csp-report";

        include /usr/share/odk/nginx/common-headers.conf;
      }
      # End of Enketo Configuration.

      location ~ ^/v\d+/oidc/callback$ {
        include /usr/share/odk/nginx/common-headers.conf;
        include /usr/share/odk/nginx/backend.conf;
      }

      location ~ ^/v\d {
        proxy_hide_header Content-Security-Policy-Report-Only;
        add_header Content-Security-Policy-Report-Only "default-src 'none'; report-uri /csp-report";

        include /usr/share/odk/nginx/common-headers.conf;
        include /usr/share/odk/nginx/backend.conf;
      }

      location @blank.html {
        root /usr/share/nginx/html;
        try_files /blank.html =404;

        add_header Content-Security-Policy-Report-Only "default-src 'none'; connect-src https://translate.google.com https://translate.googleapis.com; img-src https://translate.google.com; report-uri /csp-report";
        include /usr/share/odk/nginx/common-headers.conf;
      }
      location = /blank.html {
        try_files $uri @blank.html;
      }

      location / {
        root /usr/share/nginx/html;
        try_files $uri $uri/ /index.html;

        add_header Content-Security-Policy-Report-Only "$central_frontend_csp";

        include /usr/share/odk/nginx/common-headers.conf;
      }

    }
  common-headers.conf: |
    # This file should be included in server{}, and also in any location{}
    # which has a call to add_header.
    # See: https://nginx.org/en/docs/http/ngx_http_headers_module.html#add_header

    add_header Cache-Control $cache_header_cache_control;
    add_header Pragma        $cache_header_pragma;
    add_header Vary          $cache_header_vary;

    add_header Referrer-Policy same-origin;
    add_header Strict-Transport-Security "max-age=63072000" always;
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options nosniff;  
  client-config.json.template: |
    {
    "oidcEnabled": ${OIDC_ENABLED}
    }
  redirector.conf: |
    # Be VERY careful modifying this file - it is modified BY LINE NUMBER in setup-odk.sh
    server {
        # Listen on plain old HTTP and catch all requests so they can be redirected
        # to HTTPS instead.
        listen 80 reuseport;
        listen [::]:80 reuseport;
        server_name ${DOMAIN};
        server_tokens off;

        # Anything requesting this particular URL should be served content from
        # Certbot's folder so the HTTP-01 ACME challenges can be completed for the
        # HTTPS certificates.
        location '/.well-known/acme-challenge' {
            default_type "text/plain";
            root /var/www/letsencrypt;
        }

        # Everything else gets shunted over to HTTPS for each user defined
        # server to handle.
        location / {
            return 301 https://$http_host$request_uri;
        }
    }

    server {
        listen 80 default_server;
        listen [::]:80 default_server;
        server_tokens off;

        return 421;
    }
  backend.conf : |
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_pass http://service:8383;
    proxy_redirect off;

    # buffer requests, but not responses, so streaming out works.
    proxy_request_buffering on;
    proxy_buffering off;
    proxy_read_timeout 2m;
kind: ConfigMap
metadata:
  labels:
    app: {{ include "odk.fullname" . }}-nginx
    {{- include "odk.labels" . | nindent 4 }}
  name: {{ include "odk.fullname" . }}-nginx-config-template
